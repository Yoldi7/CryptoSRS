<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoSRS - Plataforma de Trading</title>
    <style>
        :root {
            --bg: #050607;
            --panel: #0f1115;
            --panel-2: #141821;
            --stroke: #1f2530;
            --text: #f5f7fb;
            --muted: #8f9bb3;
            --accent: #00e676;
            --accent-2: #6affc8;
            --danger: #ff4d6d;
            --warning: #fcbf49;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'SF Pro Display', 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: radial-gradient(circle at 10% 20%, rgba(0,230,118,0.10), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(106,255,200,0.08), transparent 25%),
                        linear-gradient(180deg, #080a0d 0%, #050607 55%, #040506 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 32px 18px 48px;
            position: relative;
        }

        .grid-overlay {
            position: fixed;
            inset: 0;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 32px 32px;
            pointer-events: none;
            z-index: 0;
        }

        .page {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border: 1px solid var(--stroke);
            background: rgba(20, 24, 33, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.35);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .brand-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            box-shadow: 0 0 12px rgba(0,230,118,0.6);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0,230,118,0.08);
            border: 1px solid rgba(0,230,118,0.25);
            color: var(--accent);
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-chip {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--stroke);
            border-radius: 999px;
            color: var(--text);
            font-weight: 600;
        }

        .user-chip small { color: var(--muted); font-weight: 500; }

        .ghost-button {
            background: none;
            border: 1px solid var(--stroke);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ghost-button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Auth */
        .auth-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
            align-items: stretch;
        }

        .panel {
            background: linear-gradient(145deg, rgba(20,24,33,0.95), rgba(11,13,18,0.95));
            border: 1px solid var(--stroke);
            border-radius: 18px;
            padding: 22px 22px 26px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.45);
        }

        .auth-hero h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .auth-hero p { color: var(--muted); line-height: 1.6; }

        .ticker {
            margin-top: 20px;
            display: grid;
            gap: 10px;
        }

        .ticker-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--stroke);
            border-radius: 12px;
            color: var(--text);
        }

        .ticker-row span:last-child { color: var(--accent); font-weight: 700; }

        .tabs {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            border: 1px solid var(--stroke);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px;
            color: var(--muted);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: rgba(0,230,118,0.1);
            color: var(--accent);
        }

        .auth-form { display: none; }
        .auth-form.active { display: block; }
\n        .form-group { margin-bottom: 14px; }

        label { display: block; margin-bottom: 6px; color: var(--muted); font-weight: 600; }

        input, select {
            width: 100%;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--stroke);
            color: var(--text);
            padding: 12px;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        input:focus, select:focus { outline: none; border-color: var(--accent); }

        .btn {
            width: 100%;
            border: none;
            border-radius: 12px;
            padding: 14px;
            font-weight: 800;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: #04110a;
            box-shadow: 0 10px 30px rgba(0,230,118,0.35);
        }

        .btn-primary:hover { transform: translateY(-1px); }

        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border: 1px solid var(--stroke);
        }

        .btn-inline {
            width: auto;
            padding: 10px 14px;
            font-size: 0.95rem;
        }

        .alert {
            display: none;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--stroke);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .alert.show { display: block; }
        .alert-error { background: rgba(255,77,109,0.08); color: #ffb0c1; border-color: rgba(255,77,109,0.4); }
        .alert-success { background: rgba(0,230,118,0.08); color: var(--accent-2); border-color: rgba(0,230,118,0.35); }

        /* Dashboard */
        .dashboard { display: none; flex-direction: column; gap: 18px; }
        .dashboard.active { display: flex; }

        .headline {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 12px;
        }

        .headline-card h2 { margin-bottom: 10px; }
        .headline-card p { color: var(--muted); }

        .metric-chips { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
        .chip {
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            font-weight: 700;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 14px;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--stroke);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        .card h3 { margin-bottom: 12px; letter-spacing: 0.2px; }
        .card h3 small { color: var(--muted); font-weight: 600; }

        .wallet-list, .market-list, .orders-list { display: grid; gap: 10px; }

        .wallet-item, .coin-item, .order-item {
            background: var(--panel-2);
            border: 1px solid var(--stroke);
            border-radius: 14px;
            padding: 12px 14px;
        }

        .wallet-item { display: flex; justify-content: space-between; align-items: center; }
        .wallet-item strong { color: var(--accent); }

        .coin-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .coin-info { flex: 1; min-width: 200px; }
        .coin-name { font-weight: 800; letter-spacing: 0.5px; }
        .coin-prices { display: flex; gap: 12px; color: var(--muted); }
        .coin-prices .price-buy { color: var(--accent); }
        .coin-prices .price-sell { color: var(--danger); }
        .coin-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; flex: 1; }

        .spark {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .spark svg {
            width: 120px;
            height: 42px;
            max-width: 100%;
        }

        .spark-change {
            font-weight: 800;
            font-size: 0.95rem;
        }

        .spark-change.up { color: var(--accent); }
        .spark-change.down { color: var(--danger); }

        .btn-ghost {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--stroke);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
        }

        .btn-buy { border-color: rgba(0,230,118,0.35); color: var(--accent); }
        .btn-sell { border-color: rgba(255,77,109,0.35); color: var(--danger); }

        .order-item { border-left: 3px solid var(--stroke); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .order-type { font-weight: 700; text-transform: uppercase; }
        .order-status { padding: 6px 10px; border-radius: 999px; font-weight: 700; border: 1px solid var(--stroke); }
        .order-status.pending { color: var(--warning); border-color: rgba(252,191,73,0.5); }
        .order-status.completed { color: var(--accent); border-color: rgba(0,230,118,0.4); }
        .order-status.cancelled { color: var(--danger); border-color: rgba(255,77,109,0.4); }

        .order-details { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 6px; color: var(--muted); }
        .order-detail strong { color: var(--text); }
        .order-actions { margin-top: 10px; display: flex; gap: 8px; }

        .empty { text-align: center; color: var(--muted); padding: 24px 8px; }
        .loading { color: var(--muted); padding: 10px 0; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(6px); display: none; align-items: center; justify-content: center; z-index: 5; padding: 18px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--panel); border: 1px solid var(--stroke); border-radius: 16px; padding: 18px; width: min(520px, 100%); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .close-btn { background: none; border: none; color: var(--muted); font-size: 1.4rem; cursor: pointer; }
        .close-btn:hover { color: var(--text); }

        @media (max-width: 820px) { .headline { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="grid-overlay"></div>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <span class="brand-dot"></span>
                <div>
                    <div style="font-size:1.05rem;">CryptoSRS</div>
                    <small style="color:var(--muted);">El mercado de trading m√°s seguro de la UPNA</small>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="status-pill">Mercado en vivo</span>
                <div class="user-chip" id="userInfo">
                    <div>
                        <div id="username">Usuario</div>
                        <small id="accountLevel">LEVEL</small>
                    </div>
                    <button class="ghost-button btn-inline" onclick="handleLogout()">Salir</button>
                </div>
            </div>
        </header>

        <!-- Auth -->
        <section class="panel" id="authContainer">
            <div class="auth-wrapper">
                <div class="auth-hero">
                    <h1>Opera al instante</h1>
                    <p>Precio de mercado en tiempo real y √≥rdenes inmediatas. Crea tu cuenta, recibe CTFcoin de arranque y empieza a comprar o vender con un click.</p>
                    <div class="ticker">
                        <div class="ticker-row"><span>Latencia de √≥rdenes</span><span>~150 ms</span></div>
                        <div class="ticker-row"><span>Spread medio</span><span>0.02%</span></div>
                        <div class="ticker-row"><span>Seguridad</span><span>Multi-JWT</span></div>
                    </div>
                </div>
                <div>
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="login" onclick="switchTab('login', event)">Acceder</button>
                        <button class="tab-btn" data-tab="register" onclick="switchTab('register', event)">Crear cuenta</button>
                    </div>
                    <div id="authAlert" class="alert"></div>

                    <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" id="loginUsername" placeholder="tu_usuario" required>
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a</label>
                            <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Entrar</button>
                    </form>

                    <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" id="registerUsername" minlength="3" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a</label>
                            <input type="password" id="registerPassword" minlength="6" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Crear cuenta y empezar</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Dashboard -->
        <section class="dashboard" id="dashboard">
            <div id="dashboardAlert" class="alert"></div>
            <div class="card-grid">
                <article class="card">
                    <h3>Cartera <small>(CTFcoin y crypto)</small></h3>
                    <div id="walletContent" class="wallet-list">
                        <div class="loading">Cargando cartera...</div>
                    </div>
                </article>

                <article class="card">
                    <h3>Mercado en vivo <small>Compra al mercado o limita</small></h3>
                    <div id="marketContent" class="market-list">
                        <div class="loading">Cargando mercado...</div>
                    </div>
                </article>

                <article class="card">
                    <h3>√ìrdenes</h3>
                    <div id="ordersContent" class="orders-list">
                        <div class="loading">Cargando √≥rdenes...</div>
                    </div>
                </article>
            </div>

            <!-- Bot√≥n para comprar el plan premium -->
            <div class="card" id="buyPremiumCard">
                <h3>Comprar Plan Premium</h3>
                <p><strong>Precio: 1.0 FlagCoin</strong></p>
                <p>Al comprar este plan premium obtendr√°s la flag y te convertir√°s en usuario premium.</p>
                <button class="btn btn-primary" onclick="buyPremiumPlan()">üíé Comprar Plan Premium</button>
            </div>
            <div class="card" id="premiumCard" style="display:none;"></div>
        </section>
    </div>

    <!-- Modal de trading -->
    <div class="modal" id="tradingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Operar</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalAlert" class="alert"></div>
            <form id="tradingForm" onsubmit="handleTrade(event)">
                <input type="hidden" id="tradeCoin">
                <input type="hidden" id="tradeType">

                <div class="form-group" id="availableInfo" style="display:none;">
                    <label style="display:flex;justify-content:space-between;align-items:center;">
                        <span>Saldo disponible</span>
                        <strong id="availableAmount"></strong>
                    </label>
                </div>

                <div class="form-group">
                    <label>Importe (moneda seleccionada)</label>
                    <input type="number" id="tradeAmount" step="0.00000001" min="0.00000001" required>
                </div>

                <div class="form-group">
                    <label>Tipo de precio</label>
                    <select id="tradePriceType" onchange="togglePriceInput()">
                        <option value="market">Precio de mercado (ejecuci√≥n inmediata)</option>
                        <option value="limit">Orden l√≠mite</option>
                    </select>
                </div>

                <div class="form-group" id="targetPriceGroup" style="display: none;">
                    <label>Precio objetivo (USD)</label>
                    <input type="number" id="tradeTargetPrice" step="0.01" min="0.01">
                </div>

                <button type="submit" class="btn btn-primary" id="tradeSubmitBtn">Confirmar orden</button>
            </form>
        </div>
    </div>

    <script>
        // API expone el puerto 5001 en el host; 5000 solo es interno al contenedor
        const API_URL = 'http://localhost:5001/api';
        let authToken = null;
        let currentUser = null;
        const sparkData = {};
        const walletBalances = {};

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            if (token) {
                authToken = token;
                loadDashboard();
            }
        });

        function switchTab(tab, evt) {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            const tabButton = evt?.target || document.querySelector(`.tab-btn[data-tab=\"${tab}\"]`);
            if (tabButton) tabButton.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
            hideAlert('authAlert');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    showAlert('authAlert', 'Inicio de sesi√≥n correcto', 'success');
                    setTimeout(() => loadDashboard(), 400);
                } else {
                    showAlert('authAlert', data.error || 'Inicio de sesi√≥n fallido', 'error');
                }
            } catch (error) {
                showAlert('authAlert', 'Error de conexi√≥n', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('authAlert', 'Registro exitoso. Revisa tu usuario y entra.', 'success');
                    setTimeout(() => {
                        switchTab('login');
                        document.getElementById('loginUsername').value = username;
                    }, 1200);
                } else {
                    showAlert('authAlert', data.error || 'Registro fallido', 'error');
                }
            } catch (error) {
                showAlert('authAlert', 'Error de conexi√≥n', 'error');
            }
        }

        function handleLogout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('userInfo').style.display = 'none';
        }

        async function loadDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            await loadUserInfo();
            await Promise.all([loadWallet(), loadMarket(), loadOrders()]);
            await showPremiumCard();
        }

        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_URL}/auth/profile`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data;
                    document.getElementById('username').textContent = data.username;
                    document.getElementById('accountLevel').textContent = data.account_level.toUpperCase();
                    document.getElementById('userInfo').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error al cargar perfil', error);
            }
        }

        async function loadWallet() {
            try {
                const response = await fetch(`${API_URL}/trading/wallet`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const wallets = await response.json();
                    updateWalletBalances(wallets);
                    displayWallet(wallets);
                }
            } catch (error) {
                document.getElementById('walletContent').innerHTML = '<div class="empty">No se pudo cargar la cartera</div>';
            }
        }

        function displayWallet(wallets) {
            const container = document.getElementById('walletContent');

            if (!wallets.length) {
                container.innerHTML = '<div class="empty">A√∫n no tienes saldos</div>';
                return;
            }

            container.innerHTML = wallets.map(wallet => `
                <div class="wallet-item">
                    <span>${wallet.coin}</span>
                    <strong>${wallet.available.toFixed(8)}</strong>
                </div>
            `).join('');
        }

        function updateWalletBalances(wallets) {
            wallets.forEach(wallet => {
                walletBalances[wallet.coin] = wallet.available;
            });
        }

        function generateSparklineData(basePrice) {
            const points = [];
            let value = basePrice || 1;
            for (let i = 0; i < 28; i++) {
                const drift = (Math.random() - 0.5) * value * 0.004;
                value = Math.max(0.0001, value + drift);
                points.push(value);
            }
            return points;
        }

        function updateSparkline(symbol, latestPrice) {
            let data = sparkData[symbol] || generateSparklineData(latestPrice);
            const last = data[data.length - 1];
            const trend = (latestPrice - last) * 0.35;
            const jitter = (Math.random() - 0.5) * latestPrice * 0.003;
            const next = Math.max(0.0001, last + trend + jitter);
            data.push(next);
            if (data.length > 32) data.shift();
            sparkData[symbol] = data;
            return data;
        }

        function buildSparklineSvg(data) {
            const width = 120;
            const height = 42;
            const padding = 4;
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;
            const points = data.map((v, i) => {
                const x = (i / (data.length - 1)) * (width - padding * 2) + padding;
                const y = height - padding - ((v - min) / range) * (height - padding * 2);
                return { x, y };
            });
            const path = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x.toFixed(2)} ${p.y.toFixed(2)}`).join(' ');
            const change = ((data[data.length - 1] - data[0]) / data[0]) * 100;
            const color = change >= 0 ? 'var(--accent)' : 'var(--danger)';
            const lastPoint = points[points.length - 1];
            return {
                svg: `<svg viewBox="0 0 ${width} ${height}" class="sparkline" aria-hidden="true">
                        <path d="${path}" fill="none" stroke="${color}" stroke-width="2.2" stroke-linecap="round" />
                        <circle cx="${lastPoint.x.toFixed(2)}" cy="${lastPoint.y.toFixed(2)}" r="3.2" fill="${color}" />
                    </svg>`,
                change: change
            };
        }

        function renderSparkline(coin) {
            const midPrice = (coin.buy_price + coin.sell_price) / 2;
            const series = updateSparkline(coin.coin, midPrice);
            const { svg, change } = buildSparklineSvg(series);
            const trendClass = change >= 0 ? 'up' : 'down';
            const trendLabel = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
            return `
                <div class="spark">
                    ${svg}
                    <span class="spark-change ${trendClass}">${trendLabel}</span>
                </div>
            `;
        }

        async function loadMarket() {
            try {
                const response = await fetch(`${API_URL}/trading/coins`);

                if (response.ok) {
                    const coins = await response.json();
                    displayMarket(coins);
                }
            } catch (error) {
                document.getElementById('marketContent').innerHTML = '<div class="empty">No se pudo cargar el mercado</div>';
            }
        }

        function displayMarket(coins) {
            const container = document.getElementById('marketContent');

            container.innerHTML = coins.map(coin => `
                <div class="coin-item">
                    <div class="coin-info">
                        <div class="coin-name">${coin.coin}</div>
                        <div class="coin-prices">
                            <span class="price-buy">Compra: $${coin.buy_price.toFixed(2)}</span>
                            <span class="price-sell">Venta: $${coin.sell_price.toFixed(2)}</span>
                        </div>
                        ${renderSparkline(coin)}
                    </div>
                    <div class="coin-actions">
                        <button class="btn-ghost btn-buy" onclick="openTradeModal('${coin.coin}', 'BUY', ${coin.buy_price})">Comprar ahora</button>
                        <button class="btn-ghost btn-sell" onclick="openTradeModal('${coin.coin}', 'SELL', ${coin.sell_price})">Vender</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/trading/orders`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const orders = await response.json();
                    displayOrders(orders);
                }
            } catch (error) {
                document.getElementById('ordersContent').innerHTML = '<div class="empty">No se pudieron cargar las √≥rdenes</div>';
            }
        }

        function displayOrders(orders) {
            const container = document.getElementById('ordersContent');

            if (!orders.length) {
                container.innerHTML = '<div class="empty">Sin √≥rdenes abiertas</div>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-item">
                    <div class="order-header">
                        <span class="order-type">${order.order_type}</span>
                        <span class="order-status ${order.status}">${order.status.toUpperCase()}</span>
                    </div>
                    <div class="order-details">
                        <div class="order-detail"><span>Moneda</span><strong>${order.coin}</strong></div>
                        <div class="order-detail"><span>Cantidad</span><strong>${order.amount}</strong></div>
                        <div class="order-detail"><span>Precio</span><strong>$${order.target_price.toFixed(2)}</strong></div>
                        <div class="order-detail"><span>Tipo</span><strong>${order.price_type}</strong></div>
                    </div>
                    ${order.status === 'pending' ? `
                        <div class="order-actions">
                            <button class="ghost-button" onclick="executeOrder(${order.id})">Ejecutar ahora</button>
                            <button class="ghost-button" onclick="cancelOrder(${order.id})">Cancelar</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function openTradeModal(coin, type, price) {
            document.getElementById('tradeCoin').value = coin;
            document.getElementById('tradeType').value = type;
            document.getElementById('modalTitle').textContent = `${type === 'BUY' ? 'Comprar' : 'Vender'} ${coin}`;
            document.getElementById('tradeAmount').value = '';
            document.getElementById('tradePriceType').value = 'market';
            document.getElementById('tradeTargetPrice').value = price;
            document.getElementById('targetPriceGroup').style.display = 'none';
            hideAlert('modalAlert');
            document.getElementById('tradingModal').classList.add('active');

            const available = walletBalances[coin] || 0;
            const availableInfo = document.getElementById('availableInfo');
            const availableAmount = document.getElementById('availableAmount');
            if (type === 'SELL') {
                availableInfo.style.display = 'block';
                availableAmount.textContent = `${available.toFixed(8)} ${coin}`;
            } else {
                availableInfo.style.display = 'none';
            }
        }

        function closeModal() { document.getElementById('tradingModal').classList.remove('active'); }

        function togglePriceInput() {
            const priceType = document.getElementById('tradePriceType').value;
            const targetPriceGroup = document.getElementById('targetPriceGroup');
            if (priceType === 'limit') {
                targetPriceGroup.style.display = 'block';
                document.getElementById('tradeTargetPrice').required = true;
            } else {
                targetPriceGroup.style.display = 'none';
                document.getElementById('tradeTargetPrice').required = false;
            }
        }

        async function handleTrade(e) {
            e.preventDefault();

            const coin = document.getElementById('tradeCoin').value;
            const amount = parseFloat(document.getElementById('tradeAmount').value);
            const orderType = document.getElementById('tradeType').value;
            const priceType = document.getElementById('tradePriceType').value;
            const targetPrice = parseFloat(document.getElementById('tradeTargetPrice').value);

            if (orderType === 'SELL') {
                const available = walletBalances[coin] || 0;
                if (!available || amount > available) {
                    showAlert('modalAlert', `No tienes saldo suficiente de ${coin}. Disponible: ${available.toFixed(8)}`, 'error');
                    return;
                }
            }

            try {
                const response = await fetch(`${API_URL}/trading/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        coin,
                        amount,
                        order_type: orderType,
                        price_type: priceType,
                        target_price: targetPrice
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('modalAlert', 'Orden creada. Si es de mercado, ejec√∫tala al instante.', 'success');
                    setTimeout(() => {
                        closeModal();
                        loadWallet();
                        loadOrders();
                    }, 900);
                } else {
                    showAlert('modalAlert', data.error || 'No se pudo crear la orden', 'error');
                }
            } catch (error) {
                showAlert('modalAlert', 'Error de conexi√≥n', 'error');
            }
        }

        async function executeOrder(orderId) {
            try {
                const response = await fetch(`${API_URL}/trading/execute-order/${orderId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Orden ejecutada correctamente');
                    loadWallet();
                    loadOrders();
                } else {
                    alert(data.error || 'No se pudo ejecutar');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        async function cancelOrder(orderId) {
            try {
                const response = await fetch(`${API_URL}/trading/cancel-order/${orderId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Orden cancelada');
                    loadWallet();
                    loadOrders();
                } else {
                    alert(data.error || 'No se pudo cancelar');
                }
            } catch (error) {
                alert('Error de conexi√≥n');
            }
        }

        async function buyPremiumPlan() {
            try {
                const response = await fetch(`${API_URL}/flags/buy-premium`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('dashboardAlert', `¬°Felicidades! ${data.message}\n\nFlag: ${data.flag}\n\nBalance restante: ${data.remaining_balance.toFixed(8)} FlagCoin`, 'success');
                    // Actualizar el estado del usuario a premium
                    document.getElementById('userInfo').innerHTML = `<strong>${currentUser}</strong> <small>Premium ‚≠ê</small>`;
                    document.getElementById('userInfo').style.display = 'flex';
                    await loadWallet(); // Actualizar el balance de FlagCoin
                } else {
                    showAlert('dashboardAlert', data.message || 'No tienes suficientes FlagCoin para comprar el plan premium.', 'error');
                }
            } catch (error) {
                showAlert('dashboardAlert', 'Error de conexi√≥n.', 'error');
            }
        }

        async function showPremiumCard() {
            // Oculta la tarjeta de compra y muestra la flag si eres premium
            const premiumCard = document.getElementById('premiumCard');
            const buyCard = document.getElementById('buyPremiumCard');
            if (currentUser && currentUser.account_level === 'premium') {
                // Obtener la flag del backend
                try {
                    const response = await fetch(`${API_URL}/flags/user`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (response.ok && data.flag) {
                        premiumCard.innerHTML = `
                            <h3>üéâ ¬°Eres usuario premium!</h3>
                            <p>Tu flag es:</p>
                            <div style='font-size:1.2rem;word-break:break-all;background:rgba(0,230,118,0.08);border-radius:8px;padding:12px 16px;margin:12px 0;border:1px solid var(--accent);color:var(--accent);font-weight:700;'>${data.flag}</div>
                            <p>¬°Felicidades por completar el reto!</p>
                        `;
                        premiumCard.style.display = 'block';
                        buyCard.style.display = 'none';
                    } else {
                        premiumCard.innerHTML = `<h3>üéâ ¬°Eres usuario premium!</h3><p>No se pudo cargar la flag.</p>`;
                        premiumCard.style.display = 'block';
                        buyCard.style.display = 'none';
                    }
                } catch (error) {
                    premiumCard.innerHTML = `<h3>üéâ ¬°Eres usuario premium!</h3><p>Error de conexi√≥n al cargar la flag.</p>`;
                    premiumCard.style.display = 'block';
                    buyCard.style.display = 'none';
                }
            } else {
                premiumCard.style.display = 'none';
                buyCard.style.display = 'block';
            }
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
        }

        function hideAlert(elementId) {
            const alert = document.getElementById(elementId);
            alert.classList.remove('show');
        }
    </script>
</body>
</html>
